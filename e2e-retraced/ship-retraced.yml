---
####
assets:
  v1:
  - inline:
      contents: |
        #!/bin/sh
        kubectl get ns {{repl config "namespace"}} \
        || \
        kubectl create ns {{repl config "namespace" }}

        kubectl apply -n {{repl config "namespace" }} -f ./assets/k8s/

      dest: ./assets/install.sh
      mode: 0777
  - inline:
      contents: |
        #!/bin/sh
        kubectl delete -n {{repl config "namespace" }} -f ./assets/k8s/

      dest: ./assets/uninstall.sh
      mode: 0777
  - inline:
      contents: |
        apiVersion: v1
        kind: Pod
        metadata:
          name: retraced-pg-migrate
          labels:
            app: retraced-pg-migrate
        spec:{{repl if (ne (config "image_pull_secret") "") }}
          imagePullSecrets:
            - name: {{repl config "image_pull_secret"}}{{repl end}}
          containers:
            - name: db
              image: {{repl config "docker_registry"}}/retraced-db:1.1.12-slim-20180329
              command:
                - bin/retraceddb
                - up
                - pg
              env:
                - name: POSTGRES_USER
                  valueFrom:
                    secretKeyRef:
                      name: retraced-postgres
                      key: POSTGRES_USER
                - name: POSTGRES_PASSWORD
                  valueFrom:
                    secretKeyRef:
                      name: retraced-postgres
                      key: POSTGRES_PASSWORD
                - name: POSTGRES_HOST
                  valueFrom:
                    secretKeyRef:
                      name: retraced-postgres
                      key: POSTGRES_HOST
                - name: POSTGRES_PORT
                  valueFrom:
                    secretKeyRef:
                      name: retraced-postgres
                      key: POSTGRES_PORT
                - name: POSTGRES_DATABASE
                  valueFrom:
                    secretKeyRef:
                      name: retraced-postgres
                      key: POSTGRES_DATABASE
      dest: ./assets/k8s/postgres.yml
      mode: 0666
  - docker:
      image: registry.replicated.com/shipretraced/retraced-db:1.1.12-slim-20180329
      dest: docker/db.tar
      source: replicated

config:
  v1:
    - name: cluster_info
      title: Kubernetes Cluster Info
      description: information about your kubernetes cluster
      items:
      - name: namespace
        title: Namespace to Deploy into
        type: text
        required: true
        default: default
      - name: api_replicas
        title: Number of api servers to deploy
        type: text
        required: true
        default: 2
      - name: worker_replicas
        title: Number of Workers to deploy
        type: text
        required: true
        default: 2
      - name: docker_registry
        title: |
          Base URL of a private docker registry.
          You will need to provision following repositories provisioned:
           - `retraced-db`
           - `retraced-api`
           - `retraced-processor`
        required: true
        type: text
      - name: image_pull_secret
        title: '[Optional] Name of an image pull secret to use when pulling from your private docker registry'
        required: false
        type: text

lifecycle:
  v1:
  - render:
      skip_state_warning: true
  - message:
     level: warn
     contents: |
       A state file has been written to {{repl context "state_file_path" }} -- please store it
       somewhere safe, you'll need it if you want to update or recover this installation of SuperBigTool.
